# docker-compose.raspi.yml
# Full production stack — runs on any Linux host (RPi 4, x86_64 NAS, mini-PC, etc.).
# Runs 24/7: Freqtrade (inference) + signal-cli + OpenClaw.
# All images are multi-arch; Docker pulls the correct variant automatically.
#
# Two path variables (set in .environment):
#   DATA_ROOT       Persistent data: models, signal-cli, openclaw state.
#                   RPi: /mnt/ssd   |   NAS: /volume1/docker/tradbot-data
#   RASPI_STACK_PATH  Repo root: where configs and skills are read from.
#                   Often ${DATA_ROOT}/tradbot, but can differ (e.g. NAS repo
#                   at /volume1/docker/tradbot with data at a separate volume).
#
# Prerequisites:
#   - DATA_ROOT exists and is mounted
#   - RASPI_STACK_PATH contains the cloned/synced repo (run deploy_stack.sh)
#   - .environment filled in (copy from .env.example)
#   - Pre-trained model at $DATA_ROOT/freqtrade/user_data/models/
#   - signal-cli bot number registered
#
# Usage:
#   docker compose -f docker-compose.raspi.yml --env-file .environment up -d
#   docker compose -f docker-compose.raspi.yml --env-file .environment restart freqtrade
#   docker compose -f docker-compose.raspi.yml --env-file .environment logs -f

services:

  # ── Freqtrade — inference + live trading ──────────────────────────────────
  freqtrade:
    image: freqtradeorg/freqtrade:stable_freqai
    restart: unless-stopped
    volumes:
      # user_data (models, logs) — on persistent data storage
      - ${DATA_ROOT:-/mnt/ssd}/freqtrade/user_data:/freqtrade/user_data
      # configs — read from repo (keep in sync via deploy_stack.sh)
      - ${RASPI_STACK_PATH:-/mnt/ssd/tradbot}/freqtrade/config.json:/freqtrade/config.json:ro
      - ${RASPI_STACK_PATH:-/mnt/ssd/tradbot}/freqtrade/config.freqai.json:/freqtrade/config.freqai.json:ro
      # dev override: switches exchange to Binance for dry-run (remove for live Kraken trading)
      - ${RASPI_STACK_PATH:-/mnt/ssd/tradbot}/freqtrade/config.dev.json:/freqtrade/config.dev.json:ro
      # strategies — read from repo
      - ${RASPI_STACK_PATH:-/mnt/ssd/tradbot}/freqtrade/user_data/strategies:/freqtrade/user_data/strategies:ro
    ports:
      # Bind to LAN IP only — never expose 0.0.0.0 in production
      - "${PROD_LAN_IP:-127.0.0.1}:8080:8080"
    command: >
      trade
      --config /freqtrade/config.json
      --config /freqtrade/config.freqai.json
      --config /freqtrade/config.dev.json
      --strategy LightGBMStrategy
      --freqaimodel LightGBMRegressor
      --logfile /freqtrade/user_data/logs/freqtrade.log
    env_file:
      - .environment
    environment:
      - FREQTRADE__EXCHANGE__KEY=${KRAKEN_API_KEY}
      - FREQTRADE__EXCHANGE__SECRET=${KRAKEN_SECRET}
      - FREQTRADE__DRY_RUN=${DRY_RUN:-true}
      - FREQTRADE__API_SERVER__ENABLED=true
      - FREQTRADE__API_SERVER__LISTEN_IP_ADDRESS=0.0.0.0
      - FREQTRADE__API_SERVER__USERNAME=${FREQTRADE_USERNAME:-trader}
      - FREQTRADE__API_SERVER__PASSWORD=${FREQTRADE_PASSWORD}
    healthcheck:
      # /api/v1/ping is unauthenticated — no credentials needed
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/ping"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - tradbot

  # ── signal-cli — Signal messenger backend ─────────────────────────────────
  signal-cli:
    image: bbernhard/signal-cli-rest-api:latest
    restart: unless-stopped
    volumes:
      # Signal account data — persists across restarts
      - ${DATA_ROOT:-/mnt/ssd}/signal-data:/home/.local/share/signal-cli
    environment:
      - MODE=json-rpc
    networks:
      - tradbot

  # ── OpenClaw — Signal → Haiku gateway ─────────────────────────────────────
  openclaw:
    image: ghcr.io/boernmaster/tradbot-openclaw:latest
    restart: unless-stopped
    volumes:
      # Persistent OpenClaw state (Signal account, cache)
      - ${DATA_ROOT:-/mnt/ssd}/openclaw:/root/.openclaw
      # Skill config — read from repo, updated via deploy_stack.sh
      - ${RASPI_STACK_PATH:-/mnt/ssd/tradbot}/openclaw/openclaw.json:/root/.openclaw/openclaw.json:ro
      - ${RASPI_STACK_PATH:-/mnt/ssd/tradbot}/openclaw/skills:/root/.openclaw/workspace/skills:ro
    depends_on:
      - signal-cli
      - freqtrade
    env_file:
      - .environment
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENCLAW_BOT_NUMBER=${OPENCLAW_BOT_NUMBER}
      - OPENCLAW_ALLOW_FROM=${OPENCLAW_ALLOW_FROM}
      - SIGNAL_CLI_URL=http://signal-cli:8080
    networks:
      - tradbot

networks:
  tradbot:
    driver: bridge
